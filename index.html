<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·¥äº‹å·¥ç¨‹è¡¨</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

  :root {
    --bg: #f0f2f5;
    --surface: #ffffff;
    --surface2: #f7f8fa;
    --border: #e2e6ea;
    --border2: #d0d5dd;
    --text-primary: #1a1f2e;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --accent: #2563eb;
    --accent-light: #eff6ff;
    --today-line: #ef4444;
    --header-bg: #1a1f2e;
    --header-text: #e2e6ea;
    --row-hover: #f1f5f9;
    --group-bg: #f8fafc;
    --font-main: 'Noto Sans JP', sans-serif;
    --font-mono: 'IBM Plex Mono', monospace;
    --panel-width: 540px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-main);
    background: var(--bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ===== TOP BAR ===== */
  .topbar {
    background: var(--header-bg);
    color: var(--header-text);
    display: flex;
    align-items: center;
    padding: 0 16px;
    height: 48px;
    gap: 12px;
    flex-shrink: 0;
    border-bottom: 1px solid #2d3748;
  }
  .topbar-title {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: #fff;
    margin-right: 8px;
  }
  .topbar-sep { width: 1px; height: 24px; background: #3d4a5c; }

  .gas-section {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
  }
  .gas-section input {
    flex: 1;
    max-width: 380px;
    padding: 5px 10px;
    border: 1px solid #3d4a5c;
    border-radius: 6px;
    background: #232b3a;
    color: #e2e6ea;
    font-size: 11px;
    font-family: var(--font-mono);
    outline: none;
  }
  .gas-section input::placeholder { color: #4a5568; }
  .gas-section input:focus { border-color: var(--accent); }

  .btn {
    padding: 5px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 12px;
    font-family: var(--font-main);
    font-weight: 500;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-sync {
    background: var(--accent);
    color: #fff;
  }
  .btn-sync:hover { background: #1d4ed8; }
  .btn-paste {
    background: #2d3748;
    color: #cbd5e0;
    border: 1px solid #3d4a5c;
  }
  .btn-paste:hover { background: #374151; }
  .btn-nav {
    background: #2d3748;
    color: #cbd5e0;
    border: 1px solid #3d4a5c;
    padding: 4px 8px;
    font-size: 14px;
  }
  .btn-nav:hover { background: #374151; }
  .btn-today {
    background: #2d3748;
    color: #cbd5e0;
    border: 1px solid #3d4a5c;
    font-size: 11px;
  }
  .btn-today:hover { background: #374151; }

  .scale-select {
    padding: 5px 8px;
    border: 1px solid #3d4a5c;
    border-radius: 6px;
    background: #232b3a;
    color: #e2e6ea;
    font-size: 11px;
    font-family: var(--font-main);
    cursor: pointer;
    outline: none;
  }

  .sort-select {
    padding: 5px 8px;
    border: 1px solid #3d4a5c;
    border-radius: 6px;
    background: #232b3a;
    color: #e2e6ea;
    font-size: 11px;
    font-family: var(--font-main);
    cursor: pointer;
    outline: none;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-label {
    font-size: 11px;
    color: var(--text-muted);
  }

  /* ===== MAIN AREA ===== */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ===== LEFT PANEL ===== */
  .left-panel {
    width: var(--panel-width);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    border-right: 2px solid var(--border2);
    background: var(--surface);
    overflow: hidden;
  }

  .panel-header {
    display: grid;
    grid-template-columns: 32px 1fr 52px 68px 72px 68px 60px;
    background: var(--header-bg);
    color: var(--header-text);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    border-bottom: 1px solid #2d3748;
    flex-shrink: 0;
    user-select: none;
  }
  .panel-header .ph-cell {
    padding: 9px 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 3px;
    border-right: 1px solid #2d3748;
    transition: background 0.1s;
    white-space: nowrap;
    overflow: hidden;
  }
  .panel-header .ph-cell:hover { background: #2d3748; }
  .panel-header .ph-cell:last-child { border-right: none; }
  .ph-cell .sort-arrow { color: #60a5fa; font-size: 9px; }

  .panel-body {
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
  }
  .panel-body::-webkit-scrollbar { width: 4px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .group-header {
    background: var(--group-bg);
    border-bottom: 1px solid var(--border);
    border-top: 1px solid var(--border);
    padding: 5px 10px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
    letter-spacing: 0.04em;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .group-count {
    background: var(--border2);
    color: var(--text-secondary);
    border-radius: 10px;
    padding: 1px 7px;
    font-size: 10px;
    font-weight: 500;
  }

  .panel-row {
    display: grid;
    grid-template-columns: 32px 1fr 52px 68px 72px 68px 60px;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    cursor: pointer;
    min-height: 38px;
    align-items: center;
  }
  .panel-row:hover { background: var(--row-hover); }
  .panel-row.selected { background: var(--accent-light); }

  .pr-cell {
    padding: 5px 6px;
    font-size: 11px;
    border-right: 1px solid var(--border);
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 4px;
    min-height: 38px;
  }
  .pr-cell:last-child { border-right: none; }

  .row-num {
    font-size: 10px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    justify-content: center;
  }

  .color-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .case-name {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.3;
    word-break: break-all;
  }

  .undecided {
    color: var(--text-muted) !important;
    font-style: italic;
    font-size: 10px !important;
  }

  .power-badge {
    display: inline-block;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }
  .power-toku { background: #7c3aed; color: #fff; }
  .power-ko   { background: #dc2626; color: #fff; }
  .power-tei  { background: #059669; color: #fff; }
  .power-other{ background: #6b7280; color: #fff; }

  /* ===== CHART AREA ===== */
  .chart-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .chart-header {
    background: var(--header-bg);
    border-bottom: 1px solid #2d3748;
    flex-shrink: 0;
    overflow: hidden;
    position: relative;
  }

  .chart-body {
    flex: 1;
    overflow: auto;
    position: relative;
    cursor: default;
  }
  .chart-body::-webkit-scrollbar { height: 6px; width: 4px; }
  .chart-body::-webkit-scrollbar-track { background: transparent; }
  .chart-body::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  .chart-canvas-wrap {
    position: relative;
    display: inline-block;
    min-width: 100%;
  }

  canvas { display: block; }

  /* ===== TOOLTIP ===== */
  #tooltip {
    position: fixed;
    background: #1a1f2e;
    color: #e2e6ea;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1000;
    display: none;
    max-width: 280px;
    line-height: 1.8;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }
  #tooltip strong { color: #fff; font-size: 13px; display: block; margin-bottom: 4px; }

  /* ===== DATE HIGHLIGHT BAR ===== */
  #date-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--header-bg);
    color: #e2e6ea;
    padding: 8px 20px;
    font-size: 12px;
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 999;
    border-top: 1px solid #2d3748;
  }

  /* ===== PASTE MODAL ===== */
  #paste-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #paste-modal.show { display: flex; }
  .modal-box {
    background: var(--surface);
    border-radius: 12px;
    padding: 24px;
    width: 560px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .modal-box h3 { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .modal-box p { font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6; }
  .modal-box textarea {
    width: 100%;
    height: 160px;
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 10px;
    font-size: 11px;
    font-family: var(--font-mono);
    resize: vertical;
    outline: none;
    margin-bottom: 12px;
  }
  .modal-box textarea:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .btn-primary { background: var(--accent); color: #fff; padding: 7px 16px; }
  .btn-primary:hover { background: #1d4ed8; }
  .btn-cancel { background: var(--surface2); color: var(--text-secondary); border: 1px solid var(--border2); padding: 7px 16px; }
  .btn-cancel:hover { background: var(--border); }

  /* ===== LOADING ===== */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--text-muted);
    font-size: 13px;
    gap: 8px;
  }
  .empty-state .icon { font-size: 32px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <span class="topbar-title">å·¥äº‹å·¥ç¨‹è¡¨</span>
  <div class="topbar-sep"></div>
  <div class="gas-section">
    <input type="text" id="gas-url" placeholder="Google Apps Script ã® Web App URL ã‚’è²¼ã‚Šä»˜ã‘">
    <button class="btn btn-sync" onclick="fetchFromGAS()">â†» åŒæœŸ</button>
    <button class="btn btn-paste" onclick="openPaste()">ğŸ“‹ è²¼ã‚Šä»˜ã‘</button>
  </div>
  <div class="topbar-sep"></div>
  <select class="sort-select" id="sort-select" onchange="applySort()">
    <option value="none">å…ƒã®é †ç•ª</option>
    <option value="co">å·¥äº‹ä¼šç¤¾</option>
    <option value="sales">è‡ªç¤¾æ‹…å½“</option>
    <option value="eng">å·¥å‹™æ‹…å½“</option>
    <option value="area">ã‚¨ãƒªã‚¢</option>
    <option value="power">å—é›»</option>
    <option value="start">ç€å·¥æ—¥</option>
    <option value="end">å®Œå·¥æ—¥</option>
  </select>
  <div class="topbar-sep"></div>
  <button class="btn btn-nav" onclick="navigate(-1)">â€¹</button>
  <button class="btn btn-today" onclick="goToday()">ä»Šæ—¥</button>
  <button class="btn btn-nav" onclick="navigate(1)">â€º</button>
  <select class="scale-select" id="scale-select" onchange="changeScale()">
    <option value="1w">1é€±é–“</option>
    <option value="2w">2é€±é–“</option>
    <option value="1m" selected>æœˆ</option>
    <option value="3m">3ã‹æœˆ</option>
    <option value="6m">åŠå¹´</option>
    <option value="1y">1å¹´</option>
  </select>
  <div class="topbar-sep"></div>
  <span id="status-dot" class="status-dot" style="background:#4a5568"></span>
  <span id="status-label" class="status-label">ãƒ‡ãƒ¼ã‚¿ãªã—</span>
</div>

<!-- MAIN -->
<div class="main">
  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="panel-header">
      <div class="ph-cell" onclick="headerSort('num')">#</div>
      <div class="ph-cell" onclick="headerSort('name')">æ¡ˆä»¶å</div>
      <div class="ph-cell" onclick="headerSort('power')">å—é›»</div>
      <div class="ph-cell" onclick="headerSort('area')">ã‚¨ãƒªã‚¢</div>
      <div class="ph-cell" onclick="headerSort('sales')">è‡ªç¤¾æ‹…å½“</div>
      <div class="ph-cell" onclick="headerSort('eng')">å·¥å‹™æ‹…å½“</div>
      <div class="ph-cell" onclick="headerSort('co')">å·¥äº‹ä¼šç¤¾</div>
    </div>
    <div class="panel-body" id="panel-body">
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- CHART -->
  <div class="chart-area">
    <div class="chart-header" id="chart-header">
      <canvas id="header-canvas" height="44"></canvas>
    </div>
    <div class="chart-body" id="chart-body" onscroll="syncScroll()">
      <div class="chart-canvas-wrap" id="chart-canvas-wrap">
        <canvas id="chart-canvas"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- TOOLTIP -->
<div id="tooltip"></div>

<!-- DATE BAR -->
<div id="date-bar"></div>

<!-- PASTE MODAL -->
<div id="paste-modal">
  <div class="modal-box">
    <h3>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</h3>
    <p>
      ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®<strong>5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿è¡Œ</strong>ã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
      èª­ã¿è¾¼ã‚€åˆ—ï¼š<strong>Dï¼ˆæ¡ˆä»¶åï¼‰, Fï¼ˆå—é›»ï¼‰, Gï¼ˆç¨®åˆ¥ï¼‰, Hï¼ˆã‚¨ãƒªã‚¢ï¼‰, Iï¼ˆè‡ªç¤¾æ‹…å½“ï¼‰, Kï¼ˆå·¥å‹™æ‹…å½“ï¼‰, Mï¼ˆå·¥äº‹ä¼šç¤¾ï¼‰, Tï¼ˆç€å·¥ï¼‰, Uï¼ˆå®Œå·¥ï¼‰</strong>
    </p>
    <textarea id="paste-area" placeholder="ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closePaste()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="loadPaste()">èª­ã¿è¾¼ã‚€</button>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
let allData = [];
let displayData = [];
let currentSort = 'none';
let currentSortAsc = true;
let headerSortKey = null;

// ===== SCALE & VIEW =====
const SCALES = {
  '1w':  { days: 7,   cellW: 80, label: 'day' },
  '2w':  { days: 14,  cellW: 50, label: 'day' },
  '1m':  { days: 30,  cellW: 28, label: 'day' },
  '3m':  { days: 90,  cellW: 14, label: 'week' },
  '6m':  { days: 180, cellW: 10, label: 'week' },
  '1y':  { days: 365, cellW: 7,  label: 'week' },
};
let currentScale = '1m';
let viewStart = new Date();
const ROW_H = 38;
const HEADER_H = 44;

// Sync left panel scroll with chart
let panelBody = null;
function syncScroll() {
  const chartBody = document.getElementById('chart-body');
  if (panelBody) panelBody.scrollTop = chartBody.scrollTop;
}

// ===== COLORS =====
const PALETTE = [
  '#2563eb','#7c3aed','#059669','#d97706','#dc2626',
  '#0891b2','#65a30d','#c026d3','#ea580c','#0284c7',
  '#4f46e5','#16a34a','#9333ea','#b45309','#be123c',
];
function getColor(idx) { return PALETTE[idx % PALETTE.length]; }

// ===== POWER BADGE =====
function powerClass(p) {
  const s = (p||'').trim();
  if (s.includes('ç‰¹é«˜')) return 'power-toku';
  if (s.includes('é«˜åœ§')) return 'power-ko';
  if (s.includes('ä½åœ§')) return 'power-tei';
  return s ? 'power-other' : '';
}
function powerLabel(p) {
  const s = (p||'').trim();
  if (!s) return '';
  if (s.includes('ç‰¹é«˜')) return 'ç‰¹é«˜';
  if (s.includes('é«˜åœ§')) return 'é«˜åœ§';
  if (s.includes('ä½åœ§')) return 'ä½åœ§';
  return s;
}

// ===== SORT ORDER =====
const POWER_ORDER = {'ç‰¹é«˜':0,'é«˜åœ§':1,'ä½åœ§':2,'':99};
function getPowerRank(p) {
  const lbl = powerLabel(p);
  return POWER_ORDER[lbl] ?? 3;
}

function applySort() {
  currentSort = document.getElementById('sort-select').value;
  headerSortKey = null;
  updateHeaderHighlight(null);
  renderAll();
}

function headerSort(key) {
  if (headerSortKey === key) {
    currentSortAsc = !currentSortAsc;
  } else {
    headerSortKey = key;
    currentSortAsc = true;
    currentSort = 'none';
    document.getElementById('sort-select').value = 'none';
  }
  updateHeaderHighlight(key);
  renderAll();
}

function updateHeaderHighlight(key) {
  const cells = document.querySelectorAll('.ph-cell');
  const keys = ['num','name','power','area','sales','eng','co'];
  cells.forEach((c, i) => {
    const arrows = c.querySelectorAll('.sort-arrow');
    arrows.forEach(a => a.remove());
    if (keys[i] === key) {
      const arrow = document.createElement('span');
      arrow.className = 'sort-arrow';
      arrow.textContent = currentSortAsc ? ' â–²' : ' â–¼';
      c.appendChild(arrow);
    }
  });
}

function getSortedData() {
  let data = [...allData];
  const sk = headerSortKey || currentSort;

  if (sk === 'none' || sk === 'num') {
    if (headerSortKey === 'num') data.sort((a,b) => currentSortAsc ? a._idx - b._idx : b._idx - a._idx);
    return data;
  }

  const getValue = (item, key) => {
    const map = {
      'power': item.power, 'area': item.area,
      'sales': item.sales, 'eng': item.eng, 'co': item.co,
      'name': item.name,
      'start': item.start, 'end': item.end,
    };
    return map[key] || '';
  };

  const empty = (v) => !v || v.trim() === '';

  if (sk === 'power') {
    data.sort((a,b) => {
      if (empty(a.power) && empty(b.power)) return 0;
      if (empty(a.power)) return 1;
      if (empty(b.power)) return -1;
      const ra = getPowerRank(a.power), rb = getPowerRank(b.power);
      return currentSortAsc ? ra - rb : rb - ra;
    });
  } else if (sk === 'start' || sk === 'end') {
    data.sort((a,b) => {
      const va = a[sk] ? new Date(a[sk]) : null;
      const vb = b[sk] ? new Date(b[sk]) : null;
      if (!va && !vb) return 0;
      if (!va) return 1;
      if (!vb) return -1;
      return currentSortAsc ? va - vb : vb - va;
    });
  } else {
    data.sort((a,b) => {
      const va = getValue(a, sk), vb = getValue(b, sk);
      if (empty(va) && empty(vb)) return 0;
      if (empty(va)) return 1;
      if (empty(vb)) return -1;
      const cmp = va.localeCompare(vb, 'ja');
      return currentSortAsc ? cmp : -cmp;
    });
  }
  return data;
}

function getGroupKey(item) {
  const sk = headerSortKey || currentSort;
  if (sk === 'co') return item.co || '';
  if (sk === 'area') return item.area || '';
  if (sk === 'sales') return item.sales || '';
  if (sk === 'eng') return item.eng || '';
  if (sk === 'power') return powerLabel(item.power) || '';
  return null;
}

// ===== RENDER ALL =====
function renderAll() {
  displayData = getSortedData();
  renderPanel();
  renderChart();
}

// ===== PANEL RENDER =====
function renderPanel() {
  panelBody = document.getElementById('panel-body');
  const sk = headerSortKey || currentSort;
  const showGroups = ['co','area','sales','eng','power'].includes(sk);

  let html = '';
  let lastGroup = Symbol();

  displayData.forEach((item, vi) => {
    const gk = showGroups ? getGroupKey(item) : null;
    if (showGroups && gk !== lastGroup) {
      const label = gk || 'æœªæ±ºå®š';
      const count = displayData.filter(d => getGroupKey(d) === gk).length;
      html += `<div class="group-header">
        <span>${escHtml(label)}</span>
        <span class="group-count">${count}ä»¶</span>
      </div>`;
      lastGroup = gk;
    }

    const color = getColor(item._idx);
    const pbl = powerLabel(item.power);
    const pbc = powerClass(item.power);

    const td = (v, cls='') => {
      const val = v ? escHtml(v) : '<span class="undecided">æœªæ±ºå®š</span>';
      return `<div class="pr-cell ${cls}">${val}</div>`;
    };

    html += `<div class="panel-row" data-vi="${vi}" onclick="selectRow(${vi})">
      <div class="pr-cell row-num">${vi+1}</div>
      <div class="pr-cell">
        <div class="color-dot" style="background:${color}"></div>
        <span class="case-name">${escHtml(item.name)}</span>
      </div>
      <div class="pr-cell">
        ${pbl ? `<span class="power-badge ${pbc}">${pbl}</span>` : '<span class="undecided">-</span>'}
      </div>
      ${td(item.area)}
      ${td(item.sales)}
      ${td(item.eng)}
      ${td(item.co)}
    </div>`;
  });

  if (!html) {
    html = `<div class="empty-state"><div class="icon">ğŸ“‹</div><div>ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</div></div>`;
  }
  panelBody.innerHTML = html;

  // Sync panel scroll with chart
  panelBody.addEventListener('scroll', () => {
    document.getElementById('chart-body').scrollTop = panelBody.scrollTop;
  });
}

let selectedVI = -1;
function selectRow(vi) {
  selectedVI = vi;
  document.querySelectorAll('.panel-row').forEach(r => r.classList.remove('selected'));
  const el = document.querySelector(`.panel-row[data-vi="${vi}"]`);
  if (el) el.classList.add('selected');
}

// ===== CHART RENDER =====
const hCanvas = document.getElementById('header-canvas');
const hCtx = hCanvas.getContext('2d');
const cCanvas = document.getElementById('chart-canvas');
const cCtx = cCanvas.getContext('2d');

function getScaleConfig() {
  return SCALES[currentScale];
}

function getViewDates() {
  const sc = getScaleConfig();
  const end = new Date(viewStart);
  end.setDate(end.getDate() + sc.days);
  return { start: new Date(viewStart), end };
}

function renderChart() {
  const sc = getScaleConfig();
  const { start, end } = getViewDates();
  const totalDays = sc.days;
  const cellW = sc.cellW;
  const totalW = totalDays * cellW;
  const totalH = displayData.length * ROW_H;
  const today = new Date();
  today.setHours(0,0,0,0);

  // Header canvas
  const dpr = window.devicePixelRatio || 1;
  const chartAreaW = document.getElementById('chart-area')?.offsetWidth || document.getElementById('chart-body').offsetWidth;
  const canvasW = Math.max(totalW, chartAreaW);

  hCanvas.width = canvasW * dpr;
  hCanvas.height = HEADER_H * dpr;
  hCanvas.style.width = canvasW + 'px';
  hCanvas.style.height = HEADER_H + 'px';
  hCtx.scale(dpr, dpr);
  hCtx.clearRect(0, 0, canvasW, HEADER_H);

  cCanvas.width = canvasW * dpr;
  cCanvas.height = Math.max(totalH, 200) * dpr;
  cCanvas.style.width = canvasW + 'px';
  cCanvas.style.height = Math.max(totalH, 200) + 'px';
  cCtx.scale(dpr, dpr);
  cCtx.clearRect(0, 0, canvasW, Math.max(totalH, 200));

  // BG
  hCtx.fillStyle = '#1a1f2e';
  hCtx.fillRect(0, 0, canvasW, HEADER_H);
  cCtx.fillStyle = '#ffffff';
  cCtx.fillRect(0, 0, canvasW, Math.max(totalH, 200));

  // Draw columns
  const labelMode = sc.label;
  let x = 0;
  const cur = new Date(start);

  if (labelMode === 'day') {
    for (let d = 0; d < totalDays; d++) {
      const isToday = cur.toDateString() === today.toDateString();
      const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
      const isMon = cur.getDay() === 1;

      // Header bg
      hCtx.fillStyle = isToday ? '#1e3a5f' : '#1a1f2e';
      hCtx.fillRect(x, 0, cellW, HEADER_H);

      // Header label
      if (cellW >= 20 || isMon) {
        hCtx.fillStyle = isToday ? '#60a5fa' : (isWeekend ? '#64748b' : '#94a3b8');
        hCtx.font = `${cellW >= 28 ? 10 : 9}px 'IBM Plex Mono'`;
        hCtx.textAlign = 'center';

        if (cellW >= 28) {
          hCtx.fillText(String(cur.getDate()).padStart(2,'0'), x + cellW/2, 18);
          if (isMon || d === 0) {
            hCtx.fillStyle = '#60a5fa';
            hCtx.font = `bold 9px 'Noto Sans JP'`;
            hCtx.fillText(`${cur.getMonth()+1}/${cur.getDate()}`, x + cellW/2, 36);
          }
        } else {
          if (isMon || d === 0) {
            hCtx.fillStyle = '#94a3b8';
            hCtx.fillText(`${cur.getMonth()+1}/${cur.getDate()}`, x + cellW/2, 26);
          }
        }
      }

      // Body grid
      cCtx.fillStyle = isWeekend ? '#f8fafc' : '#fff';
      displayData.forEach((_, ri) => {
        cCtx.fillRect(x, ri * ROW_H, cellW, ROW_H);
      });
      if (isWeekend) {
        cCtx.fillStyle = '#f1f5f9';
        cCtx.fillRect(x, 0, cellW, Math.max(totalH, 200));
      }

      // Grid lines
      hCtx.strokeStyle = isMon ? '#2d3748' : '#232b3a';
      hCtx.lineWidth = isMon ? 1 : 0.5;
      hCtx.beginPath(); hCtx.moveTo(x, 0); hCtx.lineTo(x, HEADER_H); hCtx.stroke();

      cCtx.strokeStyle = isMon ? '#d0d5dd' : '#e2e6ea';
      cCtx.lineWidth = isMon ? 1 : 0.5;
      cCtx.beginPath(); cCtx.moveTo(x, 0); cCtx.lineTo(x, Math.max(totalH, 200)); cCtx.stroke();

      cur.setDate(cur.getDate() + 1);
      x += cellW;
    }
  } else {
    // Week mode â€” xã¯æ—¥æ•°Ã—cellWã§çµ±ä¸€
    while (cur < end) {
      const dayOffset = Math.round((cur - start) / 86400000);
      x = dayOffset * cellW;
      const wW = cellW * 7;

      hCtx.fillStyle = '#1a1f2e';
      hCtx.fillRect(x, 0, wW, HEADER_H);

      const isFirstOfMonth = cur.getDate() <= 7;
      hCtx.fillStyle = isFirstOfMonth ? '#60a5fa' : '#94a3b8';
      hCtx.font = isFirstOfMonth ? `bold 9px 'Noto Sans JP'` : `9px 'IBM Plex Mono'`;
      hCtx.textAlign = 'center';
      if (isFirstOfMonth) {
        hCtx.fillText(`${cur.getMonth()+1}æœˆ`, x + wW/2, 18);
        hCtx.fillStyle = '#64748b';
        hCtx.font = `9px 'IBM Plex Mono'`;
        hCtx.fillText(`${cur.getDate()}`, x + wW/2, 34);
      } else {
        hCtx.fillText(`${cur.getMonth()+1}/${cur.getDate()}`, x + wW/2, 26);
      }

      hCtx.strokeStyle = '#2d3748';
      hCtx.lineWidth = 1;
      hCtx.beginPath(); hCtx.moveTo(x, 0); hCtx.lineTo(x, HEADER_H); hCtx.stroke();

      cCtx.strokeStyle = '#d0d5dd';
      cCtx.lineWidth = 0.5;
      cCtx.beginPath(); cCtx.moveTo(x, 0); cCtx.lineTo(x, Math.max(totalH, 200)); cCtx.stroke();

      cur.setDate(cur.getDate() + 7);
    }
  }

  // Row lines
  displayData.forEach((_, ri) => {
    cCtx.strokeStyle = '#e2e6ea';
    cCtx.lineWidth = 0.5;
    cCtx.beginPath();
    cCtx.moveTo(0, ri * ROW_H);
    cCtx.lineTo(canvasW, ri * ROW_H);
    cCtx.stroke();
  });

  // Gantt bars
  displayData.forEach((item, ri) => {
    if (!item.start || !item.end) return;
    const s = new Date(item.start); s.setHours(0,0,0,0);
    const e = new Date(item.end);   e.setHours(0,0,0,0);
    const color = getColor(item._idx);

    const daysSinceStart = (s - start) / 86400000;
    const duration = (e - s) / 86400000 + 1;
    const bx = daysSinceStart * cellW;
    const bw = duration * cellW;
    const by = ri * ROW_H + 8;
    const bh = ROW_H - 16;

    if (bx + bw < 0 || bx > canvasW) return;

    // Bar
    const clampX = Math.max(0, bx);
    const clampW = Math.min(bx + bw, canvasW) - clampX;
    if (clampW <= 0) return;

    cCtx.fillStyle = color + '26';
    cCtx.beginPath();
    cCtx.roundRect(clampX, by, clampW, bh, 3);
    cCtx.fill();

    cCtx.fillStyle = color;
    const barLeftW = Math.min(6, clampW);
    cCtx.beginPath();
    cCtx.roundRect(clampX, by, barLeftW, bh, [3, 0, 0, 3]);
    cCtx.fill();

    // Label
    if (bw > 40) {
      cCtx.fillStyle = color;
      cCtx.font = `500 10px 'Noto Sans JP'`;
      cCtx.textAlign = 'left';
      const labelX = clampX + 10;
      const maxTextW = clampW - 16;
      let label = item.name;
      if (cCtx.measureText(label).width > maxTextW) {
        while (label.length > 1 && cCtx.measureText(label + 'â€¦').width > maxTextW)
          label = label.slice(0, -1);
        label += 'â€¦';
      }
      cCtx.fillText(label, labelX, by + bh/2 + 4);
    }

    // Store bar coords for interaction
    item._bar = { x: bx, y: by, w: bw, h: bh, ri };
  });

  // Today line
  const todayOff = (today - start) / 86400000;
  if (todayOff >= 0 && todayOff <= totalDays) {
    const tx = todayOff * cellW;

    hCtx.strokeStyle = '#ef4444';
    hCtx.lineWidth = 2;
    hCtx.beginPath(); hCtx.moveTo(tx, 0); hCtx.lineTo(tx, HEADER_H); hCtx.stroke();

    // Today label
    hCtx.fillStyle = '#ef4444';
    hCtx.font = `bold 9px 'IBM Plex Mono'`;
    hCtx.textAlign = 'center';
    hCtx.fillText('TODAY', tx, 10);

    cCtx.strokeStyle = '#ef4444';
    cCtx.lineWidth = 1.5;
    cCtx.setLineDash([4, 3]);
    cCtx.beginPath(); cCtx.moveTo(tx, 0); cCtx.lineTo(tx, Math.max(totalH, 200)); cCtx.stroke();
    cCtx.setLineDash([]);
  }
}

// ===== NAVIGATION =====
function navigate(dir) {
  const sc = getScaleConfig();
  const days = Math.max(1, Math.floor(sc.days / 2));
  viewStart.setDate(viewStart.getDate() + dir * days);
  renderChart();
}

function goToday() {
  const today = new Date();
  today.setHours(0,0,0,0);
  const sc = getScaleConfig();
  viewStart = new Date(today);
  viewStart.setDate(viewStart.getDate() - Math.floor(sc.days / 4));
  renderChart();
}

function changeScale() {
  currentScale = document.getElementById('scale-select').value;
  renderChart();
}

// ===== TOOLTIP =====
const tooltip = document.getElementById('tooltip');
cCanvas.addEventListener('mousemove', (e) => {
  const rect = cCanvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (cCanvas.width / cCanvas.style.width.replace('px','') / (window.devicePixelRatio||1));
  const my = (e.clientY - rect.top) * (cCanvas.height / cCanvas.style.height.replace('px','') / (window.devicePixelRatio||1));

  let found = null;
  displayData.forEach(item => {
    if (!item._bar) return;
    const { x, y, w, h } = item._bar;
    if (mx >= x && mx <= x+w && my >= y && my <= y+h) found = item;
  });

  if (found) {
    const dur = found.start && found.end ? Math.round((new Date(found.end) - new Date(found.start)) / 86400000) + 1 : '-';
    tooltip.innerHTML = `
      <strong>${escHtml(found.name)}</strong>
      ğŸ“… ç€å·¥ï¼š${found.start || '-'}<br>
      ğŸ å®Œå·¥ï¼š${found.end || '-'}<br>
      ğŸ“ æœŸé–“ï¼š${dur}æ—¥<br>
      âš¡ å—é›»ï¼š${found.power || '-'}<br>
      ğŸ“ ã‚¨ãƒªã‚¢ï¼š${found.area || '-'}<br>
      ğŸ‘¤ è‡ªç¤¾æ‹…å½“ï¼š${found.sales || '-'}<br>
      ğŸ”§ å·¥å‹™æ‹…å½“ï¼š${found.eng || '-'}<br>
      ğŸ—ï¸ å·¥äº‹ä¼šç¤¾ï¼š${found.co || '-'}
    `;
    tooltip.style.display = 'block';
    tooltip.style.left = (e.clientX + 14) + 'px';
    tooltip.style.top = (e.clientY - 10) + 'px';
    cCanvas.style.cursor = 'pointer';
  } else {
    tooltip.style.display = 'none';
    cCanvas.style.cursor = 'default';
  }
});
cCanvas.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

// ===== DATE CLICK =====
const dateBar = document.getElementById('date-bar');
let dateBarTimer = null;
hCanvas.addEventListener('click', (e) => {
  const rect = hCanvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const sc = getScaleConfig();
  const dayIdx = Math.floor(mx / sc.cellW);
  const clickedDate = new Date(viewStart);
  clickedDate.setDate(clickedDate.getDate() + dayIdx);

  const dateStr = `${clickedDate.getFullYear()}/${clickedDate.getMonth()+1}/${clickedDate.getDate()}`;
  const active = displayData.filter(item => {
    if (!item.start || !item.end) return false;
    const s = new Date(item.start), en = new Date(item.end);
    return clickedDate >= s && clickedDate <= en;
  });

  dateBar.style.display = 'flex';
  dateBar.innerHTML = `<strong>${dateStr}</strong> â€” ä½œæ¥­ä¸­ï¼š<strong>${active.length}ä»¶</strong> ${active.map(i => `<span style="background:#2d3748;padding:2px 8px;border-radius:4px;font-size:11px;">${escHtml(i.name)}</span>`).join(' ')}`;
  clearTimeout(dateBarTimer);
  dateBarTimer = setTimeout(() => { dateBar.style.display = 'none'; }, 5000);
});

// ===== GAS FETCH =====
async function fetchFromGAS() {
  const url = document.getElementById('gas-url').value.trim();
  if (!url) { alert('GAS ã® URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  setStatus('loading');
  try {
    const res = await fetch(url);
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'GAS error');
    loadData(json.data);
    setStatus('ok', json.data.length + 'ä»¶');
    localStorage.setItem('gasUrl', url);
    localStorage.setItem('gasData', JSON.stringify(json.data));
  } catch(err) {
    setStatus('error');
    alert('å–å¾—å¤±æ•—: ' + err.message);
  }
}

// ===== PASTE =====
function openPaste() { document.getElementById('paste-modal').classList.add('show'); }
function closePaste() { document.getElementById('paste-modal').classList.remove('show'); }

function loadPaste() {
  const text = document.getElementById('paste-area').value;
  const rows = text.trim().split('\n').filter(r => r.trim());
  const parsed = [];
  rows.forEach(row => {
    const cols = row.split('\t');
    // Column mapping (A=0): D=3, F=5, G=6, H=7, I=8, K=10, M=12, T=19, U=20
    // Need at least 21 columns
    if (cols.length < 21) {
      console.log('è¡Œã‚¹ã‚­ãƒƒãƒ—ï¼ˆåˆ—æ•°ä¸è¶³ï¼‰:', cols.length, cols.slice(0,5));
      return;
    }
    const name = cols[3]?.trim();
    const start = cols[19]?.trim();
    const end   = cols[20]?.trim();
    console.log('èª­è¾¼:', name, start, end);
    if (!name) return;
    const s = parseDate(start), e = parseDate(end);
    // æ—¥ä»˜ãªã—ã§ã‚‚æ¡ˆä»¶åãŒã‚ã‚Œã°ç™»éŒ²ï¼ˆç€å·¥ãƒ»å®Œå·¥ã¯ç©ºã§ã‚‚OKï¼‰
    parsed.push({
      name,
      power: cols[5]?.trim() || '',
      kind:  cols[6]?.trim() || '',
      area:  cols[7]?.trim() || '',
      sales: cols[8]?.trim() || '',
      eng:   cols[10]?.trim() || '',
      co:    cols[12]?.trim() || '',
      start: s ? fmtDate(s) : '',
      end:   e ? fmtDate(e) : '',
    });
  });
  if (!parsed.length) { alert('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\nAåˆ—ã‹ã‚‰å…¨åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
  const withDates = parsed.filter(r => r.start && r.end).length;
  loadData(parsed);
  setStatus('ok', `${parsed.length}ä»¶ï¼ˆã†ã¡æ—¥ä»˜ã‚ã‚Š${withDates}ä»¶ï¼‰`);
  closePaste();
}

function parseDate(s) {
  if (!s) return null;
  // yyyy-MM-dd or yyyy/MM/dd
  const m = s.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3]);
  // "Fri Feb 20 2026 00:00:00 GMT+0900" style (Date.toString)
  const d = new Date(s);
  if (!isNaN(d)) return d;
  // Excel serial number
  const n = Number(s);
  if (!isNaN(n) && n > 30000) {
    return new Date(Date.UTC(1899,11,30) + n * 86400000);
  }
  return null;
}

function fmtDate(d) {
  if (!d) return '';
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function loadData(rows) {
  allData = rows.map((r, i) => ({ ...r, _idx: i }));
  goToday();
  renderAll();
}

function setStatus(state, label='') {
  const dot = document.getElementById('status-dot');
  const lbl = document.getElementById('status-label');
  if (state === 'ok')      { dot.style.background = '#22c55e'; lbl.textContent = label || 'OK'; }
  else if (state === 'loading') { dot.style.background = '#f59e0b'; lbl.textContent = 'èª­è¾¼ä¸­â€¦'; }
  else if (state === 'error')   { dot.style.background = '#ef4444'; lbl.textContent = 'ã‚¨ãƒ©ãƒ¼'; }
  else                          { dot.style.background = '#4a5568'; lbl.textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—'; }
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== INIT =====
(function init() {
  const today = new Date();
  today.setHours(0,0,0,0);
  viewStart = new Date(today);
  viewStart.setDate(viewStart.getDate() - 7);

  const savedUrl = localStorage.getItem('gasUrl');
  if (savedUrl) document.getElementById('gas-url').value = savedUrl;

  const savedData = localStorage.getItem('gasData');
  if (savedData) {
    try {
      loadData(JSON.parse(savedData));
      setStatus('ok', JSON.parse(savedData).length + 'ä»¶ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰');
    } catch(e) {}
  }

  renderChart();
  window.addEventListener('resize', renderChart);
})();
</script>
</body>
</html>
