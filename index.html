<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·¥äº‹å·¥ç¨‹è¡¨ 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f0f2f5; --surface:#fff; --surface2:#f5f6f9;
  --border:#e4e6ed; --border2:#c9ccd6;
  --accent:#1a56db; --accent-light:#e8f0fe; --accent-hover:#1348c0;
  --text:#1c1f2e; --text-muted:#6b7280; --text-sub:#a0aab8;
  --today:#e53e3e; --weekend-bg:#fafafa;
  --selected-col:rgba(26,86,219,0.08);
  --row-h:32px;
  --header-h:72px;
  --left-w:700px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);font-size:12px;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* â”€ Header â”€ */
.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 14px;height:48px;display:flex;align-items:center;gap:10px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.06);}
.app-title{font-size:13px;font-weight:700;color:var(--accent);white-space:nowrap;}
.vd{width:1px;height:20px;background:var(--border);}
.scale-group{display:flex;gap:1px;background:var(--surface2);border-radius:6px;padding:2px;}
.scale-btn{padding:3px 9px;border-radius:4px;border:none;background:transparent;color:var(--text-muted);font-family:'Noto Sans JP',sans-serif;font-size:10px;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap;}
.scale-btn.active{background:var(--surface);color:var(--accent);font-weight:700;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.nav-group{display:flex;align-items:center;gap:5px;}
.nav-btn{width:26px;height:26px;border-radius:5px;border:1px solid var(--border);background:var(--surface);color:var(--text-muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.period-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--text);font-weight:500;min-width:110px;text-align:center;}
.today-btn,.header-btn{padding:3px 10px;border-radius:5px;border:1px solid var(--border);background:var(--surface);color:var(--text-muted);font-family:'Noto Sans JP',sans-serif;font-size:10px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.today-btn:hover,.header-btn:hover{border-color:var(--accent);color:var(--accent);}
.header-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700;}
.header-btn.primary:hover{background:var(--accent-hover);}
.header-btn.filter-active{background:var(--accent-light);border-color:var(--accent);color:var(--accent);font-weight:700;}
.spacer{flex:1;}
.count-badge{background:var(--accent-light);color:var(--accent);border-radius:20px;padding:2px 9px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;white-space:nowrap;}
.gas-status{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-muted);white-space:nowrap;}
.status-dot{width:6px;height:6px;border-radius:50%;background:#d1d5db;}
.status-dot.connected{background:#10b981;}
.status-dot.error{background:#ef4444;}
.sort-group{display:flex;align-items:center;gap:5px;}
.sort-group label{font-size:10px;color:var(--text-muted);white-space:nowrap;font-family:'Noto Sans JP',sans-serif;letter-spacing:normal;text-transform:none;}
.sort-group select{padding:3px 24px 3px 8px;border-radius:5px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:'Noto Sans JP',sans-serif;font-size:10px;cursor:pointer;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b7280'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 7px center;}
.sort-group select:hover,.sort-group select:focus{border-color:var(--accent);}

/* â”€ Main â”€ */
.main{display:flex;flex:1;overflow:hidden;}

/* â”€ Left panel â”€ */
.task-panel{width:var(--left-w);flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.task-panel-header{height:var(--header-h);border-bottom:2px solid var(--border);display:flex;align-items:flex-end;flex-shrink:0;background:var(--surface2);}
.th-cell{height:100%;display:flex;align-items:flex-end;padding:0 6px 7px;border-right:1px solid var(--border);font-size:9px;font-weight:700;color:var(--text-muted);letter-spacing:.3px;flex-shrink:0;white-space:nowrap;overflow:hidden;user-select:none;}
.th-cell.sortable{cursor:pointer;}
.th-cell.sortable:hover{color:var(--accent);background:rgba(26,86,219,.04);}
.th-cell.sort-active{color:var(--accent);}
.th-cell.sort-active::after{content:' â–²';font-size:8px;}
.th-num{width:30px;justify-content:center;padding:0 0 7px;}
.th-name{flex:1;min-width:0;}
.th-area{width:68px;}
.th-sales{width:70px;}
.th-eng{width:70px;}
.th-const{width:86px;}
.th-power{width:68px;}

.task-scroll{flex:1;overflow-y:auto;overflow-x:hidden;}
.task-scroll::-webkit-scrollbar{width:4px;}
.task-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

.task-row{height:var(--row-h);display:flex;align-items:center;border-bottom:1px solid var(--border);transition:background .1s;cursor:default;}
.task-row:hover{background:var(--accent-light);}
.td-num{width:30px;flex-shrink:0;font-family:'DM Mono',monospace;font-size:9px;color:var(--text-sub);text-align:center;}
.td-dot-name{flex:1;min-width:0;display:flex;align-items:center;gap:6px;padding:0 6px;border-right:1px solid var(--border);overflow:hidden;height:100%;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.td-name{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:11px;font-weight:500;}
.td-cell{flex-shrink:0;padding:0 6px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:10px;color:var(--text-muted);border-right:1px solid var(--border);height:100%;display:flex;align-items:center;}
.td-area{width:68px;}
.td-sales{width:70px;}
.td-eng{width:70px;}
.td-const{width:86px;}
.td-power{width:68px;}
.undecided{color:var(--text-sub);font-style:italic;font-size:9px;}
.power-badge{display:inline-block;background:var(--accent-light);color:var(--accent);border-radius:3px;padding:1px 5px;font-size:9px;font-weight:700;font-family:'DM Mono',monospace;}

/* Group header */
.group-header-row{height:22px;display:flex;align-items:center;padding:0 10px;background:linear-gradient(90deg,var(--accent-light),transparent);border-bottom:1px solid var(--border);border-top:2px solid var(--accent);font-size:9px;font-weight:700;color:var(--accent);letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.group-chart-sep{height:22px;background:linear-gradient(90deg,var(--accent-light),rgba(26,86,219,.02));border-top:2px solid var(--accent);border-bottom:1px solid var(--border);}

/* â”€ Chart â”€ */
.chart-area{flex:1;overflow:auto;position:relative;}
.chart-area::-webkit-scrollbar{height:5px;width:4px;}
.chart-area::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
.chart-inner{position:relative;min-height:100%;}

/* Date header */
.date-header-wrap{position:sticky;top:0;z-index:20;background:var(--surface);border-bottom:2px solid var(--border);height:var(--header-h);display:flex;flex-direction:column;}
.month-row{height:24px;display:flex;border-bottom:1px solid var(--border);background:var(--surface2);}
.month-block{display:flex;align-items:center;justify-content:center;border-right:1px solid var(--border2);font-size:10px;font-weight:700;color:var(--accent);}
.day-row{height:48px;display:flex;}
.day-cell{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid var(--border);flex-shrink:0;gap:1px;cursor:pointer;transition:background .12s;position:relative;}
.day-cell:hover{background:var(--accent-light);}
.day-cell.weekend{background:var(--weekend-bg);}
.day-cell.today-cell{background:#fff5f5;}
.day-cell.selected-col{background:var(--selected-col)!important;border-right-color:var(--accent);border-left:1px solid var(--accent);}
.day-cell.label-cell{background:var(--surface2);cursor:default;}
.day-cell.label-cell:hover{background:var(--surface2);}
.day-num{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;color:var(--text-muted);line-height:1;}
.day-cell.today-cell .day-num{color:var(--today);font-weight:700;}
.day-cell.saturday .day-num{color:#3b82f6;}
.day-cell.sunday .day-num{color:#ef4444;}
.day-cell.selected-col .day-num{color:var(--accent);font-weight:700;}
.day-dow{font-size:8px;color:var(--text-sub);line-height:1;}
.day-cell.saturday .day-dow{color:#3b82f6;}
.day-cell.sunday .day-dow{color:#ef4444;}

/* Chart rows */
.chart-row{height:var(--row-h);border-bottom:1px solid var(--border);position:relative;display:flex;}
.chart-row.even{background:rgba(0,0,0,.012);}
.chart-row:hover{background:rgba(26,86,219,.03);}
.cell{flex-shrink:0;height:100%;border-right:1px solid var(--border);}
.cell.weekend{background:rgba(0,0,0,.015);}
.cell.today-col{background:rgba(229,62,62,.04);}
.cell.selected-col-cell{background:var(--selected-col)!important;}

/* Gantt bar */
.gantt-bar{position:absolute;top:50%;transform:translateY(-50%);height:18px;border-radius:4px;display:flex;align-items:center;padding:0 5px;cursor:grab;user-select:none;z-index:5;transition:box-shadow .15s,filter .15s;min-width:3px;overflow:hidden;}
.gantt-bar:hover{box-shadow:0 2px 8px rgba(0,0,0,.18);filter:brightness(1.06);z-index:10;}
.gantt-bar.dragging{cursor:grabbing;box-shadow:0 4px 16px rgba(0,0,0,.22);z-index:20;opacity:.88;}
.bar-label{font-size:9px;font-weight:600;color:rgba(255,255,255,.92);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:none;flex:1;}
.bar-resize{position:absolute;right:0;top:0;bottom:0;width:6px;cursor:ew-resize;border-radius:0 4px 4px 0;background:rgba(255,255,255,.2);}
.bar-resize:hover{background:rgba(255,255,255,.4);}

/* Today line */
.today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--today);z-index:15;pointer-events:none;}
.today-line::after{content:'';position:absolute;top:0;left:-4px;width:10px;height:10px;background:var(--today);border-radius:50%;}

/* Info bar */
.date-info-bar{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#1c1f2e;color:#fff;padding:6px 16px;border-radius:16px;font-size:11px;font-family:'DM Mono',monospace;box-shadow:0 4px 16px rgba(0,0,0,.25);z-index:50;pointer-events:none;opacity:0;transition:opacity .2s;white-space:nowrap;}
.date-info-bar.show{opacity:1;}

/* Tooltip */
.tooltip{position:fixed;background:#1c1f2e;color:#fff;padding:8px 12px;border-radius:8px;font-size:11px;pointer-events:none;z-index:100;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,.28);line-height:1.9;}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.modal{background:var(--surface);border-radius:14px;width:580px;max-width:92vw;max-height:88vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.18);}
.modal-header{padding:16px 20px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-header h2{font-size:14px;font-weight:700;}
.modal-close{width:24px;height:24px;border-radius:5px;border:none;background:var(--surface2);color:var(--text-muted);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;}
.modal-close:hover{background:var(--border);}
.modal-body{padding:16px 20px;}
.info-box{border-radius:7px;padding:10px 13px;margin-bottom:12px;font-size:11px;line-height:1.8;}
.info-box.blue{background:var(--accent-light);color:#1e3a8a;}
.info-box.yellow{background:#fffbeb;color:#92400e;border:1px solid #fde68a;}
.info-box strong{font-weight:700;}
.form-row{margin-bottom:12px;}
label{display:block;font-size:9px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);font-family:'DM Mono',monospace;margin-bottom:4px;}
input[type=text]{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 11px;border-radius:6px;font-family:'Noto Sans JP',sans-serif;font-size:12px;outline:none;transition:border-color .15s;}
input:focus{border-color:var(--accent);}
textarea{width:100%;height:170px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:10px;padding:10px;resize:vertical;outline:none;transition:border-color .15s;line-height:1.6;}
textarea:focus{border-color:var(--accent);}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn{padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text-muted);font-family:'Noto Sans JP',sans-serif;font-size:11px;cursor:pointer;transition:all .15s;}
.btn:hover{border-color:var(--border2);color:var(--text);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700;}
.btn.primary:hover{background:var(--accent-hover);}
.gas-url-row{display:flex;gap:7px;}
.gas-url-row input{flex:1;}
.gas-test-btn{padding:7px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface);color:var(--text-muted);font-size:11px;cursor:pointer;white-space:nowrap;transition:all .15s;}
.gas-test-btn:hover{border-color:var(--accent);color:var(--accent);}
.tab-group{display:flex;border-bottom:2px solid var(--border);margin-bottom:14px;}
.tab-btn{padding:8px 14px;border:none;background:transparent;font-family:'Noto Sans JP',sans-serif;font-size:11px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:700;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.hidden{display:none!important;}
.empty-chart{display:flex;flex-direction:column;align-items:center;justify-content:center;height:280px;color:var(--text-muted);gap:10px;}
.empty-icon{font-size:40px;opacity:.3;}
.empty-text{font-size:13px;font-weight:500;}
.empty-sub{font-size:11px;color:var(--text-sub);text-align:center;line-height:1.8;}

/* â”€ Print â”€ */
#printTimestamp{display:none;text-align:right;font-size:10px;color:#555;font-family:'DM Mono',monospace;padding:4px 8px 0;}
@media print{
  @page{size:A4 landscape;margin:8mm;}
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  .app-header,.modal-overlay,.tooltip,.date-info-bar,.today-line{display:none!important;}
  #printTimestamp{display:block!important;}
}

/* â”€ Filter checkbox list â”€ */
.filter-check-item{display:flex;align-items:center;gap:8px;padding:5px 8px;border-radius:5px;cursor:pointer;font-size:11px;font-weight:400;transition:background .1s;}
.filter-check-item:hover{background:var(--accent-light);}
.filter-check-item input[type=checkbox]{width:14px;height:14px;accent-color:var(--accent);flex-shrink:0;cursor:pointer;}
.filter-check-item .co-label{flex:1;}
.filter-check-item .co-count{color:var(--text-sub);font-size:10px;font-family:'DM Mono',monospace;}

/* â”€ Filter Panel â”€ */
#filterPanel{position:fixed;top:56px;right:8px;background:var(--surface);border:1px solid var(--border2);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.14);z-index:300;width:250px;display:none;}
#filterPanel.open{display:block;}
.filter-panel-header{padding:10px 12px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.filter-panel-title{font-size:11px;font-weight:700;color:var(--text);}
.filter-panel-close{border:none;background:none;cursor:pointer;font-size:14px;color:var(--text-muted);padding:0 2px;line-height:1;}
.filter-panel-close:hover{color:var(--text);}
.filter-panel-actions{padding:6px 8px;display:flex;gap:6px;border-bottom:1px solid var(--border);}
.filter-panel-actions button{flex:1;padding:4px 0;border-radius:4px;border:1px solid var(--border);background:var(--surface2);color:var(--text-muted);font-family:'Noto Sans JP',sans-serif;font-size:10px;cursor:pointer;transition:all .12s;}
.filter-panel-actions button:hover{border-color:var(--accent);color:var(--accent);}
.filter-list{max-height:260px;overflow-y:auto;padding:4px;}
.filter-list::-webkit-scrollbar{width:4px;}
.filter-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.filter-panel-footer{padding:8px 12px;border-top:1px solid var(--border);}
.filter-apply-btn{width:100%;padding:5px 0;border-radius:5px;border:none;background:var(--accent);color:#fff;font-family:'Noto Sans JP',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:background .15s;}
.filter-apply-btn:hover{background:var(--accent-hover);}
</style>
</head>
<body>

<div class="app-header">
  <span class="app-title">ğŸ“Š å·¥äº‹å·¥ç¨‹è¡¨</span>
  <div class="vd"></div>
  <div class="scale-group">
    <button class="scale-btn" data-scale="week">1é€±é–“</button>
    <button class="scale-btn active" data-scale="2weeks">2é€±é–“</button>
    <button class="scale-btn" data-scale="month">æœˆ</button>
    <button class="scale-btn" data-scale="quarter">3ã‹æœˆ</button>
    <button class="scale-btn" data-scale="half">åŠå¹´</button>
    <button class="scale-btn" data-scale="year">1å¹´</button>
  </div>
  <div class="vd"></div>
  <div class="nav-group">
    <button class="nav-btn" id="prevBtn">â€¹</button>
    <span class="period-label" id="periodLabel"></span>
    <button class="nav-btn" id="nextBtn">â€º</button>
  </div>
  <button class="today-btn" id="todayBtn">ä»Šæ—¥</button>
  <div class="vd"></div>
  <div class="sort-group">
    <label style="margin-bottom:0">ä¸¦ã³æ›¿ãˆï¼š</label>
    <select id="sortSelect">
      <option value="none">å…ƒã®é †ç•ª</option>
      <option value="co">å·¥äº‹ä¼šç¤¾</option>
      <option value="sales">è‡ªç¤¾æ‹…å½“</option>
      <option value="eng">å·¥å‹™æ‹…å½“</option>
      <option value="area">ã‚¨ãƒªã‚¢</option>
      <option value="power">å—é›»</option>
      <option value="start">ç€å·¥æ—¥</option>
      <option value="end">å®Œäº†æ—¥</option>
    </select>
  </div>
  <div class="spacer"></div>
  <span class="count-badge" id="countBadge">0 ä»¶</span>
  <div class="gas-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusLabel">æœªæ¥ç¶š</span>
  </div>
  <button class="header-btn" id="gasSettingBtn">âš™ GASé€£æº</button>
  <button class="header-btn" id="syncBtn">â†» åŒæœŸ</button>
  <button class="header-btn" id="importBtn">ğŸ“‹ è²¼ã‚Šä»˜ã‘</button>
  <button class="header-btn" id="sampleBtn">ã‚µãƒ³ãƒ—ãƒ«</button>
  <button class="header-btn" id="filterBtn">ğŸ¢ å·¥äº‹ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
  <div class="vd"></div>
  <button class="header-btn" id="printBtn">ğŸ–¨ å°åˆ·</button>
</div>

<div class="main">
  <div class="task-panel">
    <div class="task-panel-header">
      <div class="th-cell th-num">#</div>
      <div class="th-cell th-name">æ¡ˆä»¶å</div>
      <div class="th-cell th-area sortable" data-sort="area">ã‚¨ãƒªã‚¢</div>
      <div class="th-cell th-sales sortable" data-sort="sales">è‡ªç¤¾æ‹…å½“</div>
      <div class="th-cell th-eng sortable" data-sort="eng">å·¥å‹™æ‹…å½“</div>
      <div class="th-cell th-const sortable" data-sort="co">å·¥äº‹ä¼šç¤¾</div>
      <div class="th-cell th-power sortable" data-sort="power">å—é›»</div>
    </div>
    <div class="task-scroll" id="taskScroll">
      <div class="empty-chart">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
        <div class="empty-sub">ã€ŒGASé€£æºã€ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨æ¥ç¶šã™ã‚‹ã‹<br>ã€Œè²¼ã‚Šä»˜ã‘ã€ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ›</div>
      </div>
    </div>
  </div>

  <div class="chart-area" id="chartArea">
    <div class="chart-inner" id="chartInner">
      <div class="date-header-wrap" id="dateHeader"></div>
      <div id="chartRows"></div>
      <div class="today-line hidden" id="todayLine"></div>
    </div>
  </div>
</div>

<div class="date-info-bar" id="dateInfoBar"></div>
<div class="tooltip hidden" id="tooltip"></div>
<div id="printTimestamp"></div>

<!-- GAS Modal -->
<div class="modal-overlay hidden" id="gasModal">
  <div class="modal">
    <div class="modal-header">
      <h2>âš™ Google Sheets é€£æºè¨­å®š</h2>
      <button class="modal-close" onclick="closeGasModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="tab-group">
        <button class="tab-btn active" data-tab="setup">æ¥ç¶šè¨­å®š</button>
        <button class="tab-btn" data-tab="guide">GASã®è¨­å®šæ–¹æ³•</button>
      </div>
      <div class="tab-content active" id="tab-setup">
        <div class="info-box blue">Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æºã§ãã¾ã™ã€‚</div>
        <div class="form-row">
          <label>GAS Web App URL</label>
          <div class="gas-url-row">
            <input type="text" id="gasUrlInput" placeholder="https://script.google.com/macros/s/...../exec">
            <button class="gas-test-btn" id="gasTestBtn">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
          </div>
        </div>
        <div id="gasTestResult" style="margin-top:7px;font-size:11px;color:var(--text-muted)"></div>
      </div>
      <div class="tab-content" id="tab-guide">
        <div class="info-box yellow"><strong>ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®GASã«è²¼ã‚Šä»˜ã‘ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚</strong></div>
        <label>Google Apps Script ã‚³ãƒ¼ãƒ‰</label>
        <textarea id="gasCodeDisplay" readonly style="height:300px;font-size:10px;background:#1e2235;color:#a8d8a8;border-color:#2e3550"></textarea>
        <button class="btn" style="margin-top:7px" onclick="copyGasCode()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
        <div class="info-box blue" style="margin-top:10px;font-size:10px">
          <strong>æ‰‹é †ï¼š</strong><br>
          1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ â†’ æ‹¡å¼µæ©Ÿèƒ½ â†’ Apps Script<br>
          2. ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ï¼ˆCtrl+Sï¼‰<br>
          3. ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª<br>
          4. æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œï¼š<strong>è‡ªåˆ†</strong>ã€€ã‚¢ã‚¯ã‚»ã‚¹ï¼š<strong>å…¨å“¡</strong><br>
          5. URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€Œæ¥ç¶šè¨­å®šã€ã‚¿ãƒ–ã«è²¼ã‚Šä»˜ã‘
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeGasModal()">é–‰ã˜ã‚‹</button>
      <button class="btn primary" onclick="saveGasUrl()">ä¿å­˜ã—ã¦åŒæœŸ</button>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay hidden" id="importModal">
  <div class="modal">
    <div class="modal-header">
      <h2>ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è²¼ã‚Šä»˜ã‘</h2>
      <button class="modal-close" onclick="closeImportModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="info-box blue">
        <strong>æ‰‹é †ï¼š</strong> ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ã‚³ãƒ”ãƒ¼ï¼ˆCtrl+Cï¼‰â†’ ä¸‹ã«è²¼ã‚Šä»˜ã‘ï¼ˆCtrl+Vï¼‰â†’ èª­ã¿è¾¼ã‚€<br>
        <strong>ä½¿ç”¨åˆ—ï¼š</strong> D(æ¡ˆä»¶å) F(å—é›») H(ã‚¨ãƒªã‚¢) I(è‡ªç¤¾æ‹…å½“) K(å·¥å‹™æ‹…å½“) M(å·¥äº‹ä¼šç¤¾) S(ç€å·¥) T(å®Œå·¥)
      </div>
      <textarea id="pasteArea" placeholder="ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary" onclick="doImport()">èª­ã¿è¾¼ã‚€</button>
    </div>
  </div>
</div>

<!-- Filter Panel -->
<div id="filterPanel">
  <div class="filter-panel-header">
    <span class="filter-panel-title">ğŸ¢ å·¥äº‹ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</span>
    <button class="filter-panel-close" onclick="closeFilterPanel()">âœ•</button>
  </div>
  <div class="filter-panel-actions">
    <button onclick="filterSelectAll()">å…¨é¸æŠ</button>
    <button onclick="filterSelectNone()">å…¨è§£é™¤</button>
  </div>
  <div class="filter-list" id="filterList"></div>
  <div class="filter-panel-footer">
    <button class="filter-apply-btn" onclick="applyCoFilter()">é©ç”¨</button>
  </div>
</div>

<script>
// â”€â”€â”€ Column mapping (0-indexed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// C=2(æ¡ˆä»¶å), E=4(å—é›»), G=6(ã‚¨ãƒªã‚¢), H=7(å–¶æ¥­æ‹…å½“), J=9(å·¥å‹™æ‹…å½“), L=11(å·¥äº‹ä¼šç¤¾), R=17(ç€å·¥äºˆå®š), S=18(å®Œå·¥äºˆå®š)
const COL = { name:3, power:5, area:7, sales:8, eng:10, co:12, start:18, end:19 }; // D=3,F=5,H=7,I=8,K=10,M=12,S=18,T=19

const COLORS = [
  '#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4',
  '#ec4899','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48',
  '#7c3aed','#0891b2','#65a30d','#0ea5e9','#d97706','#059669','#9333ea','#0284c7'
];

let tasks = [];
let sortKey = 'none';
let scale = '2weeks';
let viewStart = null;
let selectedCol = null;
let dragState = null;
let resizeState = null;
let gasUrl = localStorage.getItem('gantt_gas_url') || '';
let dateInfoTimer = null;
let coFilter = null; // null=å…¨è¡¨ç¤º, Set=è¡¨ç¤ºã™ã‚‹å·¥äº‹ä¼šç¤¾åã®é›†åˆ

const SCALES = {
  week:    { days:7,   cellW:80, unit:'day'   },
  '2weeks':{ days:14,  cellW:52, unit:'day'   },
  month:   { days:35,  cellW:30, unit:'day'   },
  quarter: { days:91,  cellW:14, unit:'day'   },
  half:    { days:183, cellW:7,  unit:'week'  },
  year:    { days:365, cellW:4,  unit:'month' },
};

// â”€â”€â”€ GAS Code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GAS_CODE = `function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheets()[0];
    const data = sheet.getDataRange().getValues();
    const rows = [];

    for (let i = 4; i < data.length; i++) {
      const row = data[i];
      const name  = row[3];   // Dåˆ—: æ¡ˆä»¶å
      const power = row[5];   // Fåˆ—: å—é›»ç¨®åˆ¥
      const area  = row[7];   // Håˆ—: ã‚¨ãƒªã‚¢
      const sales = row[8];   // Iåˆ—: è‡ªç¤¾æ‹…å½“
      const eng   = row[10];  // Kåˆ—: å·¥å‹™æ‹…å½“
      const co    = row[12];  // Måˆ—: å·¥äº‹ä¼šç¤¾
      const start = row[18];  // Såˆ—: ç€å·¥äºˆå®š
      const end   = row[19];  // Tåˆ—: å®Œå·¥äºˆå®š

      if (!name || !start || !end) continue;
      const s  = start instanceof Date ? start : new Date(start);
      const e2 = end   instanceof Date ? end   : new Date(end);
      if (isNaN(s) || isNaN(e2)) continue;

      rows.push({
        name:  String(name),
        power: String(power || ''),
        area:  String(area  || ''),
        sales: String(sales || ''),
        eng:   String(eng   || ''),
        co:    String(co    || ''),
        start: Utilities.formatDate(s,  'Asia/Tokyo', 'yyyy-MM-dd'),
        end:   Utilities.formatDate(e2, 'Asia/Tokyo', 'yyyy-MM-dd'),
      });
    }

    return ContentService
      .createTextOutput(JSON.stringify({ ok: true, data: rows }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({ ok: false, error: err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}`;

// â”€â”€â”€ Date Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function today() { const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
function parseDate(v) {
  if (!v) return null;
  if (v instanceof Date) return new Date(v.getFullYear(),v.getMonth(),v.getDate());
  let s = String(v).trim().replace(/\//g,'-');
  const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m) return new Date(+m[1],+m[2]-1,+m[3]);
  const m2 = s.match(/^(\d{1,2})-(\d{1,2})$/);
  if (m2) return new Date(new Date().getFullYear(),+m2[1]-1,+m2[2]);
  const d = new Date(s); return isNaN(d)?null:new Date(d.getFullYear(),d.getMonth(),d.getDate());
}
function fmt(d) { if(!d)return''; return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }
function addDays(d,n) { const r=new Date(d); r.setDate(r.getDate()+n); return r; }
function diffDays(a,b) { return Math.round((b-a)/86400000); }
function startOfWeek(d) { const r=new Date(d); r.setDate(r.getDate()-((r.getDay()||7)-1)); return r; }
function startOfMonth(d) { return new Date(d.getFullYear(),d.getMonth(),1); }

// â”€â”€â”€ View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initViewStart() {
  const t = today();
  viewStart = (scale==='month'||scale==='quarter'||scale==='half'||scale==='year')
    ? startOfMonth(t) : startOfWeek(t);
}
function getViewDays() {
  if(scale==='half'||scale==='year'){
    const months=scale==='half'?6:12;
    const end=new Date(viewStart.getFullYear(),viewStart.getMonth()+months,0); // last day of period
    const arr=[]; for(let d=new Date(viewStart);d<=end;d=addDays(d,1)) arr.push(new Date(d));
    return arr;
  }
  return Array.from({length:SCALES[scale].days},(_,i)=>addDays(viewStart,i));
}
function cellW() { return SCALES[scale].cellW; }
function updatePeriodLabel() {
  const days=getViewDays(), a=days[0], b=days[days.length-1];
  const f=d=>`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
  document.getElementById('periodLabel').textContent=`${f(a)} â€“ ${f(b)}`;
}

// â”€â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSortedTasks() {
  const arr = coFilter !== null ? tasks.filter(t=>coFilter.has(t.co||'')) : [...tasks];
  const strSort=key=>arr.sort((a,b)=>{
    const va=a[key]||'', vb=b[key]||'';
    if(!va&&vb)return 1; if(va&&!vb)return -1; if(!va&&!vb)return 0;
    return va.localeCompare(vb,'ja');
  });
  switch(sortKey){
    case 'co':    return strSort('co');
    case 'sales': return strSort('sales');
    case 'eng':   return strSort('eng');
    case 'area':  return strSort('area');
    case 'power': return arr.sort((a,b)=>{
      const va=a.power||'', vb=b.power||'';
      if(!va&&vb)return 1; if(va&&!vb)return -1; if(!va&&!vb)return 0;
      // ç‰¹é«˜â†’é«˜åœ§â†’ä½åœ§ã®é †
      const rank=v=>v.includes('ç‰¹é«˜')?0:v.includes('é«˜åœ§')?1:v.includes('ä½åœ§')?2:3;
      return rank(va)-rank(vb);
    });
    case 'start': return arr.sort((a,b)=>a.start-b.start);
    case 'end':   return arr.sort((a,b)=>a.end-b.end);
    default:      return arr;
  }
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  // For half/year, always snap viewStart to the 1st of the month.
  if(scale==='half'||scale==='year') viewStart=startOfMonth(viewStart);
  renderHeader(); renderLeft(); renderChart(); updatePeriodLabel();
  // renderLeft() replaces innerHTML which resets taskScroll.scrollTop to 0.
  // Force chartArea.scrollTop to match so both panels stay in sync.
  document.getElementById('chartArea').scrollTop = document.getElementById('taskScroll').scrollTop;
  const _filtLen = coFilter !== null ? tasks.filter(t=>coFilter.has(t.co||'')).length : tasks.length;
  document.getElementById('countBadge').textContent = coFilter !== null ? `${_filtLen} / ${tasks.length} ä»¶` : `${tasks.length} ä»¶`;
  document.querySelectorAll('.th-cell.sortable').forEach(th=>{
    th.classList.toggle('sort-active', th.dataset.sort===sortKey);
  });
}

function renderHeader() {
  const days=getViewDays(), cw=cellW(), t=today(), unit=SCALES[scale].unit;
  // Month groups
  const months=[]; let cur=null;
  days.forEach(d=>{
    const key=`${d.getFullYear()}-${d.getMonth()}`;
    if(!cur||cur.key!==key){cur={key,label:d.toLocaleDateString('ja-JP',{year:'numeric',month:'long'}),count:0};months.push(cur);}
    cur.count++;
  });
  const monthHtml=months.map(m=>{
    const w=m.count*cw;
    const lbl=w>55?m.label:w>28?`${new Date(m.key.split('-')[0],m.key.split('-')[1]).getMonth()+1}æœˆ`:'';
    return `<div class="month-block" style="width:${w}px">${lbl}</div>`;
  }).join('');

  let dayHtml='';
  if (unit==='day') {
    dayHtml=days.map(d=>{
      const isToday=d.getTime()===t.getTime(), dayOfWeek=d.getDay(), isWe=dayOfWeek===0||dayOfWeek===6;
      const isSel=selectedCol&&d.getTime()===selectedCol.getTime();
      const dow=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dayOfWeek];
      let cls='day-cell';
      if(isSel)cls+=' selected-col'; else if(isToday)cls+=' today-cell'; else if(dayOfWeek===6)cls+=' weekend saturday'; else if(dayOfWeek===0)cls+=' weekend sunday';
      return `<div class="${cls}" style="width:${cw}px" data-date="${d.toISOString()}" onclick="selectDate(this)">
        <span class="day-num">${d.getDate()}</span>${cw>=24?`<span class="day-dow">${dow}</span>`:''}
      </div>`;
    }).join('');
  } else if(scale==='half'||scale==='year') {
    // half/year: group by 1st, 15th, 30th of each month
    const segs=[]; let cur=null;
    days.forEach(d=>{
      const dom=d.getDate();
      if(dom===1||dom===11||dom===21){
        if(cur) segs.push(cur);
        cur={label:String(dom), count:0};
      }
      if(cur) cur.count++;
    });
    if(cur) segs.push(cur);
    dayHtml=segs.map(seg=>{
      const sw=seg.count*cw;
      return `<div class="day-cell label-cell" style="width:${sw}px;border-right:1px solid var(--border2)">${sw>14?`<span class="day-num" style="font-size:8px">${seg.label}</span>`:''}</div>`;
    }).join('');
  } else {
    // week unit: show week start dates
    const weeks=[]; let wc=null;
    days.forEach(d=>{
      const mo=startOfWeek(d), key=mo.toISOString();
      if(!wc||wc.key!==key){wc={key,monday:mo,count:0};weeks.push(wc);}
      wc.count++;
    });
    dayHtml=weeks.map(w=>{
      const wd=`${w.monday.getMonth()+1}/${w.monday.getDate()}`;
      const ww=w.count*cw;
      return `<div class="day-cell label-cell" style="width:${ww}px;border-right:1px solid var(--border2)">
        ${ww>18?`<span class="day-num" style="font-size:${unit==='week'?10:8}px">${wd}</span>`:''}
      </div>`;
    }).join('');
  }

  document.getElementById('dateHeader').innerHTML=`<div class="month-row">${monthHtml}</div><div class="day-row">${dayHtml}</div>`;
  document.getElementById('chartInner').style.minWidth=(days.length*cw)+'px';
}

// â”€â”€â”€ Build unified display item list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDisplayItems() {
  const sorted=getSortedTasks();
  const isGrouped=sortKey!=='none'&&sortKey!=='start'&&sortKey!=='end';
  const items=[]; let lastG=null, taskIdx=0;
  sorted.forEach(task=>{
    if(isGrouped){
      const gv=task[sortKey]||'';
      if(gv!==lastG){lastG=gv;items.push({kind:'group',label:gv||'æœªæ±ºå®š'});}
    }
    items.push({kind:'task',task,idx:taskIdx++});
  });
  return items;
}

function renderLeft() {
  const scroll=document.getElementById('taskScroll');
  if (!tasks.length) {
    scroll.innerHTML=`<div class="empty-chart"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div><div class="empty-sub">ã€ŒGASé€£æºã€ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨æ¥ç¶šã™ã‚‹ã‹<br>ã€Œè²¼ã‚Šä»˜ã‘ã€ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å…¥åŠ›</div></div>`;
    return;
  }
  const items=buildDisplayItems();
  scroll.innerHTML=items.map(item=>{
    if(item.kind==='group') return `<div class="group-header-row">â–¸ ${item.label}</div>`;
    const t=item.task, i=item.idx;
    const d=(val)=>val?`<span>${val}</span>`:`<span class="undecided">æœªæ±ºå®š</span>`;
    const pwRaw=t.power||'';
    const pwColor=pwRaw.includes('ç‰¹é«˜')?'background:#7c3aed;color:#fff':pwRaw.includes('é«˜åœ§')?'background:#dc2626;color:#fff':pwRaw.includes('ä½åœ§')?'background:#059669;color:#fff':'background:var(--accent-light);color:var(--accent)';
    const pw=pwRaw?`<span class="power-badge" style="${pwColor}">${pwRaw}</span>`:`<span class="undecided">æœªæ±ºå®š</span>`;
    return `<div class="task-row" data-id="${t.id}">
      <div class="td-num">${i+1}</div>
      <div class="td-dot-name"><div class="dot" style="background:${t.color}"></div><span class="td-name" title="${t.name}">${t.name}</span></div>
      <div class="td-cell td-area">${d(t.area)}</div>
      <div class="td-cell td-sales">${d(t.sales)}</div>
      <div class="td-cell td-eng">${d(t.eng)}</div>
      <div class="td-cell td-const">${d(t.co)}</div>
      <div class="td-cell td-power">${pw}</div>
    </div>`;
  }).join('');
}

function renderChart() {
  const rows=document.getElementById('chartRows');
  if (!tasks.length) { rows.innerHTML=`<div class="empty-chart"><div class="empty-icon" style="font-size:36px;opacity:.15">ğŸ“…</div></div>`; updateTodayLine(); return; }
  const days=getViewDays(), cw=cellW(), t=today(), viewEnd=addDays(viewStart,days.length);
  let cellsHtml;
  if(scale==='half'||scale==='year'){
    // Group cells by 1st/15th/30th to match header dividers
    const segs=[]; let cur=null;
    days.forEach(d=>{
      const dom=d.getDate();
      if(dom===1||dom===11||dom===21){
        if(cur) segs.push(cur);
        cur={count:0, hasToday:false, hasSel:false};
      }
      if(cur){
        cur.count++;
        if(d.getTime()===t.getTime()) cur.hasToday=true;
        if(selectedCol&&d.getTime()===selectedCol.getTime()) cur.hasSel=true;
      }
    });
    if(cur) segs.push(cur);
    cellsHtml=segs.map(seg=>{
      const sw=seg.count*cw;
      let cls='cell';
      if(seg.hasSel) cls+=' selected-col-cell'; else if(seg.hasToday) cls+=' today-col';
      return `<div class="${cls}" style="width:${sw}px;border-right:1px solid var(--border2)"></div>`;
    }).join('');
  } else {
    cellsHtml=days.map(d=>{
      const isT=d.getTime()===t.getTime(), isWe=d.getDay()===0||d.getDay()===6;
      const isSel=selectedCol&&d.getTime()===selectedCol.getTime();
      let cls='cell';
      if(isSel)cls+=' selected-col-cell'; else if(isT)cls+=' today-col'; else if(isWe)cls+=' weekend';
      return `<div class="${cls}" style="width:${cw}px"></div>`;
    }).join('');
  }
  const items=buildDisplayItems();
  rows.innerHTML=items.map(item=>{
    if(item.kind==='group') return `<div class="group-chart-sep" style="height:22px;width:${days.length*cw}px"></div>`;
    const task=item.task, i=item.idx;
    const visible=task.end>=viewStart&&task.start<=viewEnd;
    let barHtml='';
    if(visible){
      const left=diffDays(viewStart,task.start)*cw, width=Math.max((diffDays(task.start,task.end)+1)*cw,3);
      barHtml=`<div class="gantt-bar" data-id="${task.id}" style="left:${left}px;width:${width}px;background:${task.color}"><span class="bar-label">${cw>=14?task.name:''}</span><div class="bar-resize" data-id="${task.id}"></div></div>`;
    }
    return `<div class="chart-row${i%2?'':' even'}">${cellsHtml}${barHtml}</div>`;
  }).join('');
  attachBarEvents(); updateTodayLine(); syncScroll();
}

function updateTodayLine() {
  const line=document.getElementById('todayLine'), days=getViewDays(), cw=cellW(), t=today();
  const idx=days.findIndex(d=>d.getTime()===t.getTime());
  if(idx>=0){line.classList.remove('hidden');line.style.left=(idx*cw+cw/2)+'px';}else line.classList.add('hidden');
}

// â”€â”€â”€ Scroll Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let syncing=false;
function syncScroll(){
  const ts=document.getElementById('taskScroll'), ca=document.getElementById('chartArea');
  const onC=()=>{if(syncing)return;syncing=true;ts.scrollTop=ca.scrollTop;syncing=false;};
  const onL=()=>{if(syncing)return;syncing=true;ca.scrollTop=ts.scrollTop;syncing=false;};
  ca.removeEventListener('scroll',onC);ts.removeEventListener('scroll',onL);
  ca.addEventListener('scroll',onC,{passive:true});ts.addEventListener('scroll',onL,{passive:true});
}

// â”€â”€â”€ Column click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectDate(el){
  const d=new Date(el.dataset.date);
  if(selectedCol&&selectedCol.getTime()===d.getTime()){selectedCol=null;hideInfoBar();}
  else{selectedCol=d;showInfoBar(d);}
  render();
}
function showInfoBar(d){
  const bar=document.getElementById('dateInfoBar');
  const dow=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
  const count=tasks.filter(t=>t.start<=d&&t.end>=d).length;
  bar.textContent=`ğŸ“… ${fmt(d)}ï¼ˆ${dow}ï¼‰ã€€ä½œæ¥­ä¸­ï¼š${count} ä»¶`;
  bar.classList.add('show');
  clearTimeout(dateInfoTimer);
  dateInfoTimer=setTimeout(()=>{selectedCol=null;hideInfoBar();render();},5000);
}
function hideInfoBar(){document.getElementById('dateInfoBar').classList.remove('show');}

// â”€â”€â”€ Bar drag & resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function attachBarEvents(){
  document.querySelectorAll('.gantt-bar').forEach(bar=>{
    bar.addEventListener('mousedown',onBarDown);
    bar.addEventListener('mouseenter',showTip);
    bar.addEventListener('mousemove',moveTip);
    bar.addEventListener('mouseleave',hideTip);
  });
  document.querySelectorAll('.bar-resize').forEach(h=>h.addEventListener('mousedown',onResizeDown));
}
function onBarDown(e){
  if(e.target.classList.contains('bar-resize'))return;
  e.preventDefault();hideTip();
  const bar=e.currentTarget;bar.classList.add('dragging');
  dragState={bar,id:bar.dataset.id,task:tasks.find(t=>t.id===bar.dataset.id),startX:e.clientX,origLeft:parseInt(bar.style.left)};
}
function onResizeDown(e){
  e.preventDefault();e.stopPropagation();hideTip();
  const id=e.currentTarget.dataset.id, bar=document.querySelector(`.gantt-bar[data-id="${id}"]`);
  resizeState={bar,id,task:tasks.find(t=>t.id===id),startX:e.clientX,origWidth:parseInt(bar.style.width)};
}
document.addEventListener('mousemove',e=>{
  const cw=cellW();
  if(dragState)dragState.bar.style.left=(dragState.origLeft+e.clientX-dragState.startX)+'px';
  if(resizeState)resizeState.bar.style.width=Math.max(cw,resizeState.origWidth+e.clientX-resizeState.startX)+'px';
});
document.addEventListener('mouseup',()=>{
  const cw=cellW();
  if(dragState){
    const moved=Math.round((parseInt(dragState.bar.style.left)-dragState.origLeft)/cw);
    if(moved){dragState.task.start=addDays(dragState.task.start,moved);dragState.task.end=addDays(dragState.task.end,moved);}
    dragState.bar.classList.remove('dragging');dragState=null;render();
  }
  if(resizeState){
    const days=Math.max(1,Math.round(parseInt(resizeState.bar.style.width)/cw));
    resizeState.task.end=addDays(resizeState.task.start,days-1);resizeState=null;render();
  }
});

// â”€â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTip(e){
  const task=tasks.find(t=>t.id===e.currentTarget.dataset.id);if(!task)return;
  const dur=diffDays(task.start,task.end)+1;
  const tt=document.getElementById('tooltip');
  tt.innerHTML=`<strong>${task.name}</strong><br>`
    +`ç€å·¥ï¼š${fmt(task.start)}ã€€å®Œäº†ï¼š${fmt(task.end)}ã€€æœŸé–“ï¼š${dur}æ—¥<br>`
    +(task.area?`ã‚¨ãƒªã‚¢ï¼š${task.area}<br>`:'' )
    +(task.sales?`å–¶æ¥­ï¼š${task.sales}`:'' )+(task.eng?`ã€€å·¥å‹™ï¼š${task.eng}`:'')+'<br>'
    +(task.co?`å·¥äº‹ï¼š${task.co}<br>`:'' )
    +(task.power?`å—é›»ï¼š${task.power}`:'');
  tt.classList.remove('hidden');moveTip(e);
}
function moveTip(e){const tt=document.getElementById('tooltip');tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY-60)+'px';}
function hideTip(){document.getElementById('tooltip').classList.add('hidden');}

// â”€â”€â”€ Paste Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTSV(text){
  const lines=text.trim().split('\n'); const result=[]; let ci=0;
  lines.forEach(line=>{
    const c=line.split('\t');
    if(c.length<21)return;
    const name=c[COL.name]?.trim(), start=parseDate(c[COL.start]?.trim()), end=parseDate(c[COL.end]?.trim());
    if(!name||!start||!end||start>end)return;
    result.push({id:Date.now().toString()+Math.random(),name,start,end,
      area:c[COL.area]?.trim()||'', sales:c[COL.sales]?.trim()||'',
      eng:c[COL.eng]?.trim()||'', co:c[COL.co]?.trim()||'',
      power:c.length>COL.power?c[COL.power]?.trim()||'':'',
      color:COLORS[ci++%COLORS.length]});
  });
  return result;
}
function doImport(){
  const text=document.getElementById('pasteArea').value.trim();
  if(!text)return alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
  const parsed=parseTSV(text);
  if(!parsed.length)return alert('èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\nC(æ¡ˆä»¶å)/E(å—é›»)/G(ã‚¨ãƒªã‚¢)/H(å–¶æ¥­)/J(å·¥å‹™)/L(å·¥äº‹ä¼šç¤¾)/R(ç€å·¥)/S(å®Œå·¥)åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  tasks=[...tasks,...parsed];resetCoFilter();closeImportModal();scrollToEarliest();render();
}

// â”€â”€â”€ GAS Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gasErrMsg(e){
  if(e.message==='Failed to fetch'){
    const isFile=location.protocol==='file:';
    return 'Failed to fetch\n\n'
      +(isFile
        ? 'ã€åŸå› ã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚’file://ã§ç›´æ¥é–‹ã„ã¦ã„ã‚‹ãŸã‚CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚\n'
          +'ã€å¯¾å‡¦ã€‘index.htmlã‚’Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚\n'
          +'ã€€ä¾‹ï¼šVS Code ã® Live Server æ‹¡å¼µã€ã¾ãŸã¯\n'
          +'ã€€ã€€ã€€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ python -m http.server 8000 ã‚’å®Ÿè¡Œå¾Œ\n'
          +'ã€€ã€€ã€€http://localhost:8000/index.html ã‚’é–‹ã'
        : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚\n'
          +'ãƒ»GAS URLãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆæœ«å°¾ãŒ /exec ã§ã‚ã‚‹ã“ã¨ï¼‰\n'
          +'ãƒ»GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼šã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ = å…¨å“¡');
  }
  return e.message;
}
async function syncFromGAS(){
  if(!gasUrl){openGasModal();return;}
  setStatus('loading');
  try{
    const res=await fetch(gasUrl);
    const ct=res.headers.get('content-type')||'';
    if(!ct.includes('application/json'))throw new Error('JSONãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ï¼šå…¨å“¡ï¼‰');
    const json=await res.json();
    if(!json.ok)throw new Error(json.error||'Error');
    let ci=0;
    tasks=json.data.map(r=>({
      id:Date.now().toString()+Math.random(),
      name:r.name, area:r.area||'', sales:r.sales||'', eng:r.eng||'', co:r.co||'', power:r.power||'',
      start:parseDate(r.start), end:parseDate(r.end), color:COLORS[ci++%COLORS.length]
    })).filter(t=>t.start&&t.end&&t.start<=t.end);
    setStatus('connected');resetCoFilter();scrollToEarliest();render();
  }catch(err){setStatus('error');alert('æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼š\n'+gasErrMsg(err));}
}
function setStatus(s){
  const dot=document.getElementById('statusDot'),lbl=document.getElementById('statusLabel');
  dot.className='status-dot';
  if(s==='connected'){dot.classList.add('connected');lbl.textContent='æ¥ç¶šæ¸ˆ';}
  else if(s==='error'){dot.classList.add('error');lbl.textContent='ã‚¨ãƒ©ãƒ¼';}
  else if(s==='loading')lbl.textContent='åŒæœŸä¸­â€¦';
  else lbl.textContent='æœªæ¥ç¶š';
}
async function testGasConnection(){
  const url=document.getElementById('gasUrlInput').value.trim();if(!url)return;
  const res=document.getElementById('gasTestResult');res.textContent='æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­â€¦';
  try{
    const r=await fetch(url),j=await r.json();
    if(j.ok){res.style.color='#10b981';res.textContent=`âœ“ æ¥ç¶šæˆåŠŸï¼${j.data.length}ä»¶`;}
    else{res.style.color='#ef4444';res.textContent='âœ— '+(j.error||'ä¸æ˜');}
  }catch(e){res.style.color='#ef4444';res.textContent='âœ— æ¥ç¶šå¤±æ•—ï¼š'+gasErrMsg(e).split('\n')[0];}
}
function saveGasUrl(){gasUrl=document.getElementById('gasUrlInput').value.trim();localStorage.setItem('gantt_gas_url',gasUrl);closeGasModal();syncFromGAS();}
function openGasModal(){document.getElementById('gasUrlInput').value=gasUrl;document.getElementById('gasCodeDisplay').value=GAS_CODE;document.getElementById('gasTestResult').textContent='';document.getElementById('gasModal').classList.remove('hidden');}
function closeGasModal(){document.getElementById('gasModal').classList.add('hidden');}
function copyGasCode(){navigator.clipboard.writeText(GAS_CODE).then(()=>alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));}
function openImportModal(){document.getElementById('pasteArea').value='';document.getElementById('importModal').classList.remove('hidden');setTimeout(()=>document.getElementById('pasteArea').focus(),100);}
function closeImportModal(){document.getElementById('importModal').classList.add('hidden');}

// â”€â”€â”€ Sample â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSample(){
  const t=today(),y=t.getFullYear(),m=t.getMonth();
  const areas=['åºƒå³¶å¸‚','ç¦å±±å¸‚','å°¾é“å¸‚','ä¸‰åŸå¸‚','å‘‰å¸‚'];
  const sales=['ç”°ä¸­','ä½è—¤','éˆ´æœ¨','å±±ç”°','ä¸­æ‘'];
  const engs=['æ¾æœ¬','æ¸¡è¾º','ä¼Šè—¤','å°æ—','åŠ è—¤'];
  const cos=['å¤ªé™½å…‰å·¥æ¥­','ã‚¨ã‚³ã‚½ãƒ¼ãƒ©ãƒ¼','ã‚°ãƒªãƒ¼ãƒ³ã‚¨ãƒ','ã‚µãƒ³ãƒ‘ãƒ¯ãƒ¼','ãƒ¬ãƒã‚¦ã‚¹',''];
  const powers=['50kW','100kW','200kW','300kW','500kW',''];
  const names=['ãƒ¤ã‚¯ãƒ«ãƒˆ','æ ªå¼ä¼šç¤¾ãƒ›ãƒ³ãƒ€ã‚ªãƒ¼ãƒˆ','ä¸­å°¾ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å·¥æ¥­','ã¿ãªã‚ŠæŠ€ç ”','ã‚¤ã‚±ãƒ€æ ªå¼ä¼šç¤¾',
    'æ±Ÿç”°è‡ªé€ææ‰€','å…±ç«‹å·¥æ¥­ å¢—è¨­','ã‚¯ã‚·ãƒ¨ãƒ–ãƒ¬ãƒ¼ã‚­','æ¨ªæµœã‚´ãƒ ï¼ˆæ ªï¼‰å°¾é“å·¥å ´','äº•åŸç²¾æ©Ÿ',
    'ç‹å‰åŸ ã‚«ãƒ¼ãƒãƒ¼ãƒˆ','ãƒ¡ã‚¿ã‚³ãƒ¼ãƒˆæ£’å¢—æ£Ÿ','ç¤¾ä¼šç¦ç¥‰æ³•äºº è™¹ã®ä¼š','ãƒ¯ã‚¤ã‚¨ã‚¹ãƒ†ã‚¯ãƒ',
    'ã‚¨ã‚¤ã‚³ãƒ¼é›»å­','å…ƒä¹…ä¿å·¥ä½œæ‰€','æœ‹é–“ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°','ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ãƒŠãƒ³ãƒ','ç¥é–€é…’æ¥­','åºƒå³¶å¸‚ã”ã¿å‡¦ç†æ–½è¨­'];
  tasks=names.map((name,i)=>{
    const s=addDays(new Date(y,m,1),Math.floor(Math.random()*40)-5);
    return{id:Date.now().toString()+i,name,start:s,end:addDays(s,14+Math.floor(Math.random()*60)),
      area:areas[i%areas.length],sales:sales[i%sales.length],eng:engs[i%engs.length],
      co:cos[i%cos.length],power:powers[i%powers.length],color:COLORS[i%COLORS.length]};
  });
  resetCoFilter();scrollToEarliest();render();
}

// â”€â”€â”€ Company Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getUniqueCos() {
  const set = new Set(tasks.map(t=>t.co||''));
  return [...set].sort((a,b)=>{
    if(!a && b) return 1; if(a && !b) return -1; if(!a && !b) return 0;
    return a.localeCompare(b,'ja');
  });
}
function openFilterPanel() {
  if(!tasks.length) return;
  const cos = getUniqueCos();
  const list = document.getElementById('filterList');
  list.innerHTML = cos.map(co=>{
    const label = co || 'ï¼ˆæœªè¨­å®šï¼‰';
    const cnt = tasks.filter(t=>(t.co||'')===co).length;
    const chk = coFilter===null || coFilter.has(co);
    return `<label class="filter-check-item"><input type="checkbox" value="${co.replace(/"/g,'&quot;')}" ${chk?'checked':''}><span class="co-label">${label}</span><span class="co-count">${cnt}ä»¶</span></label>`;
  }).join('');
  document.getElementById('filterPanel').classList.add('open');
}
function closeFilterPanel() {
  document.getElementById('filterPanel').classList.remove('open');
}
function filterSelectAll() {
  document.getElementById('filterList').querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=true);
}
function filterSelectNone() {
  document.getElementById('filterList').querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
}
function applyCoFilter() {
  const checked = [...document.getElementById('filterList').querySelectorAll('input[type=checkbox]:checked')].map(cb=>cb.value);
  const allCos = getUniqueCos();
  coFilter = checked.length===allCos.length ? null : new Set(checked);
  closeFilterPanel();
  const btn = document.getElementById('filterBtn');
  coFilter!==null ? btn.classList.add('filter-active') : btn.classList.remove('filter-active');
  render();
}
function resetCoFilter() {
  coFilter = null;
  document.getElementById('filterBtn').classList.remove('filter-active');
}

// â”€â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollToEarliest(){if(!tasks.length)return;const e=tasks.reduce((a,b)=>a.start<b.start?a:b);viewStart=(scale==='half'||scale==='year')?startOfMonth(e.start):addDays(e.start,-2);render();}
function navigate(dir){
  if(scale==='half'||scale==='year'){
    const months=scale==='half'?6:12;
    viewStart=new Date(viewStart.getFullYear(),viewStart.getMonth()+dir*months,1);
  } else {
    viewStart=addDays(viewStart,dir*SCALES[scale].days);
  }
  render();
}
function goToday(){
  initViewStart();render();
  setTimeout(()=>{
    const days=getViewDays(),cw=cellW(),t=today();
    const idx=days.findIndex(d=>d.getTime()===t.getTime());
    if(idx>=0)document.getElementById('chartArea').scrollLeft=Math.max(0,idx*cw-200);
  },50);
}

// â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
  });
});
document.querySelectorAll('.th-cell.sortable').forEach(th=>{
  th.addEventListener('click',()=>{
    sortKey=sortKey===th.dataset.sort?'none':th.dataset.sort;
    document.getElementById('sortSelect').value=sortKey;
    render();
  });
});
document.querySelectorAll('.scale-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.scale-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');scale=btn.dataset.scale;initViewStart();render();
  });
});
document.getElementById('sortSelect').addEventListener('change',e=>{sortKey=e.target.value;render();});
document.getElementById('prevBtn').addEventListener('click',()=>navigate(-1));
document.getElementById('nextBtn').addEventListener('click',()=>navigate(1));
document.getElementById('todayBtn').addEventListener('click',goToday);
document.getElementById('gasSettingBtn').addEventListener('click',openGasModal);
document.getElementById('syncBtn').addEventListener('click',syncFromGAS);
document.getElementById('importBtn').addEventListener('click',openImportModal);
document.getElementById('sampleBtn').addEventListener('click',loadSample);
document.getElementById('gasTestBtn').addEventListener('click',testGasConnection);
document.getElementById('filterBtn').addEventListener('click',e=>{
  e.stopPropagation();
  const panel=document.getElementById('filterPanel');
  panel.classList.contains('open') ? closeFilterPanel() : openFilterPanel();
});
document.addEventListener('click',e=>{
  const panel=document.getElementById('filterPanel');
  if(panel.classList.contains('open') && !panel.contains(e.target)) closeFilterPanel();
});
document.querySelectorAll('.modal-overlay').forEach(el=>{
  el.addEventListener('click',e=>{if(e.target===el)el.classList.add('hidden');});
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.add('hidden'));
});

// â”€â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('beforeprint',()=>{
  const _now=new Date();
  const _ts=`${_now.getFullYear()}/${String(_now.getMonth()+1).padStart(2,'0')}/${String(_now.getDate()).padStart(2,'0')} ${String(_now.getHours()).padStart(2,'0')}:${String(_now.getMinutes()).padStart(2,'0')}`;
  document.getElementById('printTimestamp').textContent='å°åˆ·æ—¥æ™‚ï¼š'+_ts;
  document.body.style.height='auto';
  document.body.style.overflow='visible';
  const main=document.querySelector('.main');
  main.style.height='auto'; main.style.overflow='visible';
  const tp=document.querySelector('.task-panel');
  tp.style.height='auto'; tp.style.overflow='visible';
  const ts=document.getElementById('taskScroll');
  ts.style.height='auto'; ts.style.overflow='visible'; ts.style.flex='none';
  const ca=document.getElementById('chartArea');
  ca.style.height='auto'; ca.style.overflow='visible'; ca.style.flex='none';
  ca.style.width=document.getElementById('chartInner').style.minWidth;
  document.getElementById('chartInner').style.minHeight='0';
  document.getElementById('dateHeader').style.position='relative';
});
window.addEventListener('afterprint',()=>{
  document.body.style.height=''; document.body.style.overflow='';
  const main=document.querySelector('.main');
  main.style.height=''; main.style.overflow='';
  const tp=document.querySelector('.task-panel');
  tp.style.height=''; tp.style.overflow='';
  const ts=document.getElementById('taskScroll');
  ts.style.height=''; ts.style.overflow=''; ts.style.flex='';
  const ca=document.getElementById('chartArea');
  ca.style.height=''; ca.style.overflow=''; ca.style.flex=''; ca.style.width='';
  document.getElementById('chartInner').style.minHeight='';
  document.getElementById('dateHeader').style.position='';
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(gasUrl)setStatus('connected');
initViewStart();render();
if(gasUrl)setTimeout(syncFromGAS,500);
</script>
</body>
</html>
